#!/usr/bin/env python3

from os import environ
from os.path import isdir
from sys import exit, stderr

odoo_conf_path = "/opt/odoo/etc/odoo.conf"
config = {}

for e, value in environ.items():
    if e.startswith("ODOOCONF__"):
        try:
            section = e.split("__")[1]
            key = e.split("__")[2]
        except IndexError:
            print("Invalid environment variable: {}".format(e), file=stderr)
            continue
        if section not in config:
            config[section] = {}
        config[section][key] = value

if isdir(odoo_conf_path):
    print("ERROR: /opt/odoo/etc/odoo.conf is a directory", file=stderr)
    exit(1)

header = '''; This configuration file is generated by 00-genconfig
; by parsing environment variables.

'''

with open(odoo_conf_path, "w") as f:
    f.write(header)
    for section, keys in config.items():
        f.write(f"[{section}]\n")
        for key, value in keys.items():
            f.write(f"{key} = {value}\n")
        f.write("\n")
